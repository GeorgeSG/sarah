# When my state changes to "home", wait for 15 minutes for the door to be opened, and then mark me as home
- id: arrival_detecion
  alias: Presence - Arrival Detection
  trigger:
    platform: state
    entity_id: person.georgi
    to: "home"
  condition:
    condition: state
    entity_id: input_boolean.georgi_home
    state: "off"
  action:
    - service: script.telegram_say
      data:
        message: "Device marked as home. Waiting for door to open!"
    - wait_template: "{{ is_state('binary_sensor.front_door_on_off', 'on') }}"
      continue_on_timeout: false
      timeout: 00:15:00
    - service: input_boolean.turn_on
      entity_id: input_boolean.georgi_home
    - service: script.telegram_say
      data:
        message: "Hey, I've marked you as home now!"

- id: leaving_home
  alias: Presence - Leaving home
  trigger:
    platform: state
    entity_id: person.georgi
    to: "not_home"
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.georgi_home
    - service: script.security_camera_on
    - service: media_player.turn_off
      entity_id:
        - media_player.living_room_tv
        - media_player.living_room_tv_2
    - service: media_player.media_stop
      entity_id: media_player.master_bedroom
    - service: light.turn_off
      entity_id: light.living_room_all_lights
    - service: input_boolean.turn_off
      entity_id: input_boolean.speech_notifications

- id: coming_home
  alias: Presence - Coming Home
  trigger:
    platform: state
    entity_id: person.georgi
    to: "home"
  action:
    - service: script.security_camera_off
    - service: light.turn_on
      entity_id: light.living_room_all_lights
    - service: input_boolean.turn_on
      entity_id: input_boolean.speech_notifications

- id: coming_home_welcome
  alias: Presence - Coming Home - Play welcome music
  trigger:
    platform: state
    entity_id: person.georgi
    to: "home"
  action:
    - service: media_player.shuffle_set
      entity_id: media_player.master_bedroom
      data:
        shuffle: true
    - service: media_player.select_source
      entity_id: media_player.master_bedroom
      data:
        source: Evening Chill
    # - service: media_player.turn_on
    #   entity_id: media_player.living_room_tv_2
    # - delay: "00:00:10"
    # - service: spotcast.start
    #   data:
    #     device_name: "Living Room TV"
    #     uri: "spotify:playlist:1dstTefWFQaBFTC6CjcEHd"
    #     random_song: true
