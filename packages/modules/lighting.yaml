# https://www.home-assistant.io/integrations/light
# https://www.home-assistant.io/integrations/light.group/

light:
  - platform: mqtt
    name: "PC"
    availability_topic: "tele/pc_light/LWT"
    command_topic: "cmnd/pc_light/POWER"
    state_topic: "tele/pc_light/STATE"
    state_value_template: "{{ value_json.POWER }}"
    brightness_command_topic: "cmnd/pc_light/Dimmer"
    brightness_state_topic: "tele/pc_light/STATE"
    brightness_scale: 100
    on_command_type: "brightness"
    brightness_value_template: "{{ value_json.Dimmer }}"
    hs_command_topic: "cmnd/pc_light/HSBColor"
    hs_state_topic: "tele/pc_light/STATE"
    hs_value_template: "{{ value_json.HSBColor.split(',')[0:2]|join(',') }}"
    color_temp_command_topic: "cmnd/pc_light/CT"
    color_temp_state_topic: "tele/pc_light/STATE"
    color_temp_value_template: "{{ value_json.CT }}"
    rgb_command_topic: "cmnd/pc_light/Color"
    rgb_state_topic: "tele/pc_light/STATE"
    rgb_value_template: "{{ value_json.Color.split(',')[0:3]|join(',') }}"
    payload_on: "ON"
    payload_off: "OFF"
    payload_available: "Online"
    payload_not_available: "Offline"
    qos: 1
    retain: false

  - platform: mqtt
    name: "Living room 1"
    availability_topic: "tele/living_room_1/LWT"
    command_topic: "cmnd/living_room_1/POWER"
    state_topic: "tele/living_room_1/STATE"
    state_value_template: "{{ value_json.POWER }}"
    brightness_command_topic: "cmnd/living_room_1/Dimmer"
    brightness_state_topic: "tele/living_room_1/STATE"
    brightness_scale: 100
    on_command_type: "brightness"
    brightness_value_template: "{{ value_json.Dimmer }}"
    color_temp_command_topic: "cmnd/living_room_1/CT"
    color_temp_state_topic: "tele/living_room_1/STATE"
    color_temp_value_template: "{{ value_json.CT }}"
    payload_on: "ON"
    payload_off: "OFF"
    payload_available: "Online"
    payload_not_available: "Offline"
    qos: 1
    retain: false

  - platform: mqtt
    name: "Living room 2"
    availability_topic: "tele/living_room_2/LWT"
    command_topic: "cmnd/living_room_2/POWER"
    state_topic: "tele/living_room_2/STATE"
    state_value_template: "{{ value_json.POWER }}"
    brightness_command_topic: "cmnd/living_room_2/Dimmer"
    brightness_state_topic: "tele/living_room_2/STATE"
    brightness_scale: 100
    on_command_type: "brightness"
    brightness_value_template: "{{ value_json.Dimmer }}"
    color_temp_command_topic: "cmnd/living_room_2/CT"
    color_temp_state_topic: "tele/living_room_2/STATE"
    color_temp_value_template: "{{ value_json.CT }}"
    payload_on: "ON"
    payload_off: "OFF"
    payload_available: "Online"
    payload_not_available: "Offline"
    qos: 1
    retain: false

  - platform: mqtt
    name: "Living room 3"
    availability_topic: "tele/living_room_3/LWT"
    command_topic: "cmnd/living_room_3/POWER"
    state_topic: "tele/living_room_3/STATE"
    state_value_template: "{{ value_json.POWER }}"
    brightness_command_topic: "cmnd/living_room_3/Dimmer"
    brightness_state_topic: "tele/living_room_3/STATE"
    brightness_scale: 100
    on_command_type: "brightness"
    brightness_value_template: "{{ value_json.Dimmer }}"
    color_temp_command_topic: "cmnd/living_room_3/CT"
    color_temp_state_topic: "tele/living_room_3/STATE"
    color_temp_value_template: "{{ value_json.CT }}"
    payload_on: "ON"
    payload_off: "OFF"
    payload_available: "Online"
    payload_not_available: "Offline"
    qos: 1
    retain: false

  - platform: mqtt
    name: "Living room 4"
    availability_topic: "tele/living_room_4/LWT"
    command_topic: "cmnd/living_room_4/POWER"
    state_topic: "tele/living_room_4/STATE"
    state_value_template: "{{ value_json.POWER }}"
    brightness_command_topic: "cmnd/living_room_4/Dimmer"
    brightness_state_topic: "tele/living_room_4/STATE"
    brightness_scale: 100
    on_command_type: "brightness"
    brightness_value_template: "{{ value_json.Dimmer }}"
    color_temp_command_topic: "cmnd/living_room_4/CT"
    color_temp_state_topic: "tele/living_room_4/STATE"
    color_temp_value_template: "{{ value_json.CT }}"
    payload_on: "ON"
    payload_off: "OFF"
    payload_available: "Online"
    payload_not_available: "Offline"
    qos: 1
    retain: false

  - platform: group
    name: Living room main lights
    entities:
      - light.living_room_1
      - light.living_room_2
      - light.living_room_3
      - light.living_room_4

  - platform: group
    name: Living room all lights
    entities:
      - light.living_room_main_lights
      - light.pc

  - platform: group
    name: All lights
    entities:
      - light.living_room_all_lights
      - light.bedside_light

sensor:
  - platform: mqtt
    name: "PC light WiFi"
    availability_topic: "tele/pc_light/LWT"
    device_class: signal_strength
    payload_available: "Online"
    payload_not_available: "Offline"
    state_topic: "tele/pc_light/STATE"
    unit_of_measurement: "%"
    value_template: "{{ value_json['Wifi'].RSSI }}"

  - platform: mqtt
    name: "Living room 1 light WiFi"
    availability_topic: "tele/living_room_1/LWT"
    device_class: signal_strength
    payload_available: "Online"
    payload_not_available: "Offline"
    state_topic: "tele/living_room_1/STATE"
    unit_of_measurement: "%"
    value_template: "{{ value_json['Wifi'].RSSI }}"

  - platform: mqtt
    name: "Living room 2 light WiFi"
    availability_topic: "tele/living_room_2/LWT"
    device_class: signal_strength
    payload_available: "Online"
    payload_not_available: "Offline"
    state_topic: "tele/living_room_2/STATE"
    unit_of_measurement: "%"
    value_template: "{{ value_json['Wifi'].RSSI }}"

  - platform: mqtt
    name: "Living room 3 light WiFi"
    availability_topic: "tele/living_room_3/LWT"
    device_class: signal_strength
    payload_available: "Online"
    payload_not_available: "Offline"
    state_topic: "tele/living_room_3/STATE"
    unit_of_measurement: "%"
    value_template: "{{ value_json['Wifi'].RSSI }}"

  - platform: mqtt
    name: "Living room 4 light WiFi"
    availability_topic: "tele/living_room_4/LWT"
    device_class: signal_strength
    payload_available: "Online"
    payload_not_available: "Offline"
    state_topic: "tele/living_room_4/STATE"
    unit_of_measurement: "%"
    value_template: "{{ value_json['Wifi'].RSSI }}"

switch:
  - platform: mqtt
    name: "PC Light Fade"
    availability_topic: "tele/pc_light/LWT"
    command_topic: "cmnd/pc_light/FADE"
    icon: mdi:gradient
    payload_available: "Online"
    payload_not_available: "Offline"
    qos: 1
    state_topic: "stat/pc_light/RESULT"
    value_template: "{{ value_json.Fade }}"

  - platform: mqtt
    name: "Living room 1 light Fade"
    availability_topic: "tele/living_room_1/LWT"
    command_topic: "cmnd/living_room_1/FADE"
    icon: mdi:gradient
    payload_available: "Online"
    payload_not_available: "Offline"
    qos: 1
    state_topic: "stat/living_room_1/RESULT"
    value_template: "{{ value_json.Fade }}"

  - platform: mqtt
    name: "Living room 2 light Fade"
    availability_topic: "tele/living_room_2/LWT"
    command_topic: "cmnd/living_room_2/FADE"
    icon: mdi:gradient
    payload_available: "Online"
    payload_not_available: "Offline"
    qos: 1
    state_topic: "stat/living_room_2/RESULT"
    value_template: "{{ value_json.Fade }}"

  - platform: mqtt
    name: "Living room 3 light Fade"
    availability_topic: "tele/living_room_3/LWT"
    command_topic: "cmnd/living_room_3/FADE"
    icon: mdi:gradient
    payload_available: "Online"
    payload_not_available: "Offline"
    qos: 1
    state_topic: "stat/living_room_3/RESULT"
    value_template: "{{ value_json.Fade }}"

  - platform: mqtt
    name: "Living room 4 light Fade"
    availability_topic: "tele/living_room_4/LWT"
    command_topic: "cmnd/living_room_4/FADE"
    icon: mdi:gradient
    payload_available: "Online"
    payload_not_available: "Offline"
    qos: 1
    state_topic: "stat/living_room_4/RESULT"
    value_template: "{{ value_json.Fade }}"

automation:
  - id: lighting_turn_on_after_sunset
    alias: Lighting · Turn on all lights after sunset
    trigger:
      platform: sun
      event: sunset
      offset: "+00:00:00"
    condition:
      - condition: state
        entity_id: binary_sensor.georgi_home
        state: "on"
    action:
      - service: light.turn_on
        entity_id: light.all_lights

  - id: lighting_turn_off_after_sunrise
    alias: Lighting · Turn off all lights after sunrise
    trigger:
      platform: sun
      event: sunrise
      offset: "+00:00:00"
    action:
      - service: light.turn_off
        entity_id: light.all_lights

  - id: lighting_master_bedroom_bedside_light_on_bedside_switch_single_click
    alias: Lighting · Master bedroom · Toggle bedside light on bedisde switch single click"
    trigger:
      platform: event
      event_type: zha_event
      event_data:
        device_ieee: !secret master_bedroom_bedside_switch_ieee
        command: single
    action:
      - service: light.toggle
        entity_id: light.bedside_light

  - id: lighting_living_room_turn_on_cube_flip_90
    alias: Lighting · Living room · Turn all lights on on Magic Cube flip 90
    trigger:
      platform: event
      event_type: zha_event
      event_data:
        device_ieee: !secret magic_cube_ieee
        command: flip
        args:
          flip_degrees: 90
    action:
      - service: light.turn_on
        entity_id: light.living_room_all_lights

  - id: lighting_living_room_turn_off_cube_flip_180
    alias: Lighting · Living room · Turn all lights off on Magic Cube flip 180
    trigger:
      platform: event
      event_type: zha_event
      event_data:
        device_ieee: !secret magic_cube_ieee
        command: flip
        args:
          flip_degrees: 180
    action:
      - service: light.turn_off
        entity_id: light.living_room_all_lights

  - id: lighting_sync_tasmota_state_on_startup
    alias: Lighting · Sync Tasmota states on start-up
    initial_state: true
    trigger:
      platform: homeassistant
      event: start
    action:
      - service: mqtt.publish
        data:
          topic: "cmnd/pc_light/STATE"
          payload: ""
      - service: mqtt.publish
        data:
          topic: "cmnd/living_room_2/STATE"
          payload: ""
      - service: mqtt.publish
        data:
          topic: "cmnd/living_room_3/STATE"
          payload: ""
      - service: mqtt.publish
        data:
          topic: "cmnd/living_room_4/STATE"
          payload: ""
