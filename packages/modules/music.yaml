group:
  all_sonos:
    name: All Sonos
    entities:
      - media_player.master_bedroom
      - media_player.living_room
      - media_player.kitchen
      - media_player.bathroom

input_select:
  sonos_leader:
    name: Sonos Leader
    initial: media_player.master_bedroom
    icon: mdi:speaker
    options:
      - media_player.master_bedroom
      - media_player.living_room
      - media_player.kitchen

binary_sensor:
  - platform: template
    sensors:
      sonos_leader_paused:
        value_template: "{{ is_state(states.input_select.sonos_leader.state, 'paused') }}"
        entity_id:
          - input_select.sonos_leader
          - media_player.master_bedroom
          - media_player.kitchen
          - media_player.living_room

script:
  music_play:
    alias: Music · Play
    sequence:
      - service: script.music_join_sonoses
      - service: media_player.volume_set
        entity_id: group.all_sonos
        data_template:
          volume_level: "{{ volume | default(0.3) }}"
      - service: media_player.shuffle_set
        data_template:
          entity_id: "{{ states('input_select.sonos_leader') }}"
          shuffle: "{{ shuffle | default(true) }}"
      - service: media_player.select_source
        data_template:
          entity_id: "{{ states('input_select.sonos_leader') }}"
          source: "{{ playlist | default('Evening Chill') }}"

  music_join_sonoses:
    alias: Music · Join Sonoses
    sequence:
      - service: sonos.join
        entity_id: group.all_sonos
        data_template:
          master: "{{ states('input_select.sonos_leader') }}"

automation:
  - id: music_pause_on_cube_knock
    alias: Music · Play/Pause on Magic Cube Knock
    trigger:
      platform: event
      event_type: zha_event
      event_data:
        device_ieee: !secret magic_cube_ieee
        command: knock
    action:
      - service: media_player.media_play_pause
        entity_id: group.all_sonos

  - id: music_volume_down_on_cube_rotate_left
    alias: Music · Volume down on Magic Cube rotate left
    trigger:
      platform: event
      event_type: zha_event
      event_data:
        device_ieee: !secret magic_cube_ieee
        command: rotate_left
    action:
      - service: media_player.volume_down
        entity_id: group.all_sonos

  - id: music_volume_up_on_cube_rotate_right
    alias: Music · Volume up on Magic Cube rotate right
    trigger:
      platform: event
      event_type: zha_event
      event_data:
        device_ieee: !secret magic_cube_ieee
        command: rotate_right
    action:
      - service: media_player.volume_up
        entity_id: group.all_sonos
